<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxury Wallpapers</title>
    <!-- Tailwind CSS CDN for modern styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for general text, Exo for the background context if desired -->
    <link href="https://fonts.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons (still needed for TikTok and Instagram) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Supabase SDK for data fetching -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom CSS for the animated background */
        @import url('https://fonts.googleapis.com/css?family=Exo:400,700');

        body {
            font-family: 'Inter', sans-serif; /* Using Inter for main content */
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            background-color: #0a0a0a; /* Fallback for body background */
        }

        /* The provided background area with dark gradient */
        .area {
            background: #0f0c29; /* fallback for old browsers */
            background: -webkit-linear-gradient(to left, #24243e, #302b63, #0f0c29); /* Chrome 10-25, Safari 5.1-6 */
            background: linear-gradient(to left, #24243e, #302b63, #0f0c29); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
            width: 100%;
            height: 100vh; /* Full viewport height */
            position: fixed; /* Fix background to viewport */
            top: 0;
            left: 0;
            z-index: -1; /* Send background behind content */
        }

        .circles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .circles li {
            position: absolute;
            display: block;
            list-style: none;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.15); /* Slightly less opaque for dark theme */
            animation: animate 25s linear infinite;
            bottom: -150px;
            border-radius: 50%; /* Make circles by default */
        }

        .circles li:nth-child(1) {
            left: 25%;
            width: 80px;
            height: 80px;
            animation-delay: 0s;
        }

        .circles li:nth-child(2) {
            left: 10%;
            width: 20px;
            height: 20px;
            animation-delay: 2s;
            animation-duration: 12s;
        }

        .circles li:nth-child(3) {
            left: 70%;
            width: 20px;
            height: 20px;
            animation-delay: 4s;
        }

        .circles li:nth-child(4) {
            left: 40%;
            width: 60px;
            height: 60px;
            animation-delay: 0s;
            animation-duration: 18s;
        }

        .circles li:nth-child(5) {
            left: 65%;
            width: 20px;
            height: 20px;
            animation-delay: 0s;
        }

        .circles li:nth-child(6) {
            left: 75%;
            width: 110px;
            height: 110px;
            animation-delay: 3s;
        }

        .circles li:nth-child(7) {
            left: 35%;
            width: 150px;
            height: 150px;
            animation-delay: 7s;
        }

        .circles li:nth-child(8) {
            left: 50%;
            width: 25px;
            height: 25px;
            animation-delay: 15s;
            animation-duration: 45s;
        }

        .circles li:nth-child(9) {
            left: 20%;
            width: 15px;
            height: 15px;
            animation-delay: 2s;
            animation-duration: 35s;
        }

        .circles li:nth-child(10) {
            left: 85%;
            width: 150px;
            height: 150px;
            animation-delay: 0s;
            animation-duration: 11s;
        }

        @keyframes animate {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }
            100% {
                transform: translateY(-1000px) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }

        /* Custom animations for icons */
        .icon-trending {
            animation: bounce-up 1.5s infinite ease-in-out;
        }

        @keyframes bounce-up {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        .icon-popular {
            animation: flicker 1s infinite alternate;
        }

        @keyframes flicker {
            0%, 100% {
                opacity: 1;
                text-shadow: 0 0 5px rgba(255, 165, 0, 0.5), 0 0 10px rgba(255, 165, 0, 0.3);
            }
            50% {
                opacity: 0.8;
                text-shadow: none;
            }
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #1a1a2e;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%; /* Adjusted width for better responsiveness */
            max-width: 1200px; /* Increased max-width for images */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hide scrollbar for categories carousel */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <div class="area">
        <ul class="circles">
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
        </ul>
    </div>

    <div class="relative z-10 flex flex-col flex-grow">
        <header class="w-full py-4 px-6 md:px-12 flex flex-col sm:flex-row items-center justify-between bg-black bg-opacity-40 shadow-lg rounded-b-xl">
            <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                <img src="https://placehold.co/40x40/302b63/FFFFFF?text=LOGO" alt="Website Logo" class="rounded-full shadow-md">
                <h1 class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">
                    Luxury Wallpapers
                </h1>
            </div>
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0">
                <div class="relative">
                    <input
                        type="search"
                        id="searchInput"
                        placeholder="Search wallpapers..."
                        class="pl-4 pr-10 py-2 rounded-full bg-gray-800 bg-opacity-70 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-300 w-full sm:w-auto min-w-[180px]"
                    >
                    <button id="searchButton" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition duration-300">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="flex space-x-4">
                    <a href="https://www.tiktok.com/" target="_blank" aria-label="TikTok" class="text-white hover:text-purple-400 transition duration-300 text-xl">
                        <i class="fab fa-tiktok"></i>
                    </a>
                    <a href="https://www.instagram.com/" target="_blank" aria-label="Instagram" class="text-white hover:text-pink-400 transition duration-300 text-xl">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://www.threads.net/" target="_blank" aria-label="Threads" class="text-white hover:text-blue-400 transition duration-300 text-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-5 h-5 fill-current">
                            <path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM294.2 244.3c19.5 9.3 33.7 23.5 41.2 40.9c10.4 24.3 11.4 63.9-20.2 95.4c-24.2 24.1-53.5 35-95.1 35.3h-.2c-46.8-.3-82.8-16.1-106.9-46.8C91.5 341.8 80.4 303.7 80 256v-.1-.1c.4-47.7 11.5-85.7 33-113.1c24.2-30.7 60.2-46.5 106.9-46.8h.2c46.9 .3 83.3 16 108.2 46.6c12.3 15.1 21.3 33.3 27 54.4l-26.9 7.2c-4.7-17.2-11.9-31.9-21.4-43.6c-19.4-23.9-48.7-36.1-87-36.4c-38 .3-66.8 12.5-85.5 36.2c-17.5 22.3-26.6 54.4-26.9 95.5c.3 41.1 9.4 73.3 26.9 95.5c18.7 23.8 47.4 36 85.5 36.2c34.3-.3 56.9-8.4 75.8-27.3c21.5-21.5 21.1-47.9 14.2-64c-4-9.4-11.4-17.3-21.3-23.3c-2.4 18-7.9 32.2-16.5 43.2c-11.4 14.5-27.7 22.4-48.4 23.5c-15.7 .9-30.8-2.9-42.6-10.7c-13.9-9.2-22-23.2-22.9-39.5c-1.7-32.2 23.8-55.3 63.5-57.6c14.1-.8 27.3-.2 39.5 1.9c-1.6-9.9-4.9-17.7-9.8-23.4c-6.7-7.8-17.1-11.8-30.8-11.9h-.4c-11 0-26 3.1-35.6 17.6l-23-15.8c12.8-19.4 33.6-30.1 58.5-30.1h.6c41.8 .3 66.6 26.3 69.1 71.8c1.4 .6 2.8 1.2 4.2 1.9l.1 .5zm-71.8 67.5c17-.9 36.4-7.6 39.7-48.8c-8.8-1.9-18.6-2.9-29-2.9c-3.2 0-6.4 .1-9.6 .3c-28.6 1.6-38.1 15.5-37.4 27.9c.9 16.7 19 24.5 36.4 23.6l-.1-.1z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 py-8 md:py-12">
            <section class="flex flex-row flex-wrap justify-center items-center gap-4 mb-4">
                <button id="trendingButton" class="flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-700 text-white font-semibold text-base rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out group">
                    <i class="fas fa-arrow-trend-up icon-trending group-hover:text-yellow-300"></i>
                    <span>Trending</span>
                </button>
                <button id="popularButton" class="flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-red-600 to-orange-700 text-white font-semibold text-base rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out group">
                    <i class="fas fa-fire icon-popular group-hover:text-yellow-300"></i>
                    <span>Popular</span>
                </button>
            </section>

            <!-- Adsterra Banner (320x50) -->
            <section class="flex justify-center my-4">
                <div class="w-[320px] h-[50px] bg-gray-800 rounded-lg overflow-hidden flex items-center justify-center text-gray-400 text-sm">
                    <!-- Adsterra Ad Code -->
                    <script type="text/javascript">
                        atOptions = {
                            'key' : 'b1235c64baf9648ab8a9059ce5035ba5',
                            'format' : 'iframe',
                            'height' : 50,
                            'width' : 320,
                            'params' : {}
                        };
                    </script>
                    <script type="text/javascript" src="//fireworkswad.com/b1235c64baf9648ab8a9059ce5035ba5/invoke.js"></script>
                </div>
            </section>
            <!-- End Adsterra Banner -->

            <section class="mb-12">
                <h2 class="text-3xl font-bold text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400">Wallpaper Categories</h2>
                <div class="relative w-full max-w-6xl mx-auto">
                    <div id="categories-carousel" class="flex overflow-x-scroll scroll-smooth pb-4 no-scrollbar gap-4">
                        <!-- Categories will be dynamically loaded here -->
                    </div>
                    <!-- Navigation arrows -->
                    <button id="prevCategory" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-70 text-white p-2 rounded-full shadow-lg z-20 hidden md:block">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button id="nextCategory" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-70 text-white p-2 rounded-full shadow-lg z-20 hidden md:block">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <!-- Pagination dots -->
                    <div id="category-pagination" class="flex justify-center space-x-2 mt-4">
                        <!-- Dots will be dynamically added -->
                    </div>
                </div>
            </section>

            <section class="mb-12">
                <h2 id="featuredWallpapersTitle" class="text-3xl font-bold text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-blue-400">Featured Wallpapers</h2>
                <div id="featuredWallpapersContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
                    </div>

                <div class="flex justify-center mt-8">
                    <button id="loadMoreButton" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out">
                        Load More Wallpapers
                    </button>
                </div>
            </section>
        </main>

        <div id="messageModal" class="modal hidden">
            <div class="modal-content text-center">
                <span class="close-button" id="closeModalButton">&times;</span>
                <h3 class="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400" id="modalTitle"></h3>
                <p class="text-gray-300 mb-4" id="modalMessage"></p>
                <div id="modalContent" class="text-left text-gray-200"></div>
            </div>
        </div>

        <footer class="w-full py-6 px-6 md:px-12 text-center bg-black bg-opacity-40 rounded-t-xl mt-12">
            <p class="text-gray-400 text-sm">&copy; 2025 Luxury Wallpapers. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // window.onload event listener to ensure all resources and DOM elements are fully loaded
        window.onload = function() {
            // Supabase Client Initialization
            // ඔබේ Supabase Dashboard එකේ "API Docs" යටතේ ඇති Project URL එක.
            const SUPABASE_URL = 'https://bddphtmddbfatuibppsp.supabase.co'; // Replace with your actual Supabase URL
            // ඔබේ Supabase Dashboard එකේ "API Docs" යටතේ ඇති "anon (public)" key එක.
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkZHBodG1kZGJmYXR1aWJwcHNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4ODc3MzMsImV4cCI6MjA2NDQ2MzczM30.u484-EmP6RqM8UQS5gv0RaYj4szI4iGIFffv6Z3wJaw'; // Replace with your actual Supabase Anon Key

            // Supabase client එක window.supabase හරහා initialize කර ඇත.
            // Supabase library load වීමට අපොහොසත් වුවහිට දෝෂ හැසිරවීම.
            if (!window.supabase) {
                console.error("Supabase library failed to load. Please check the script URL or network connection.");
                showModal('Error', 'Failed to load Supabase library. Please try again later.');
                return;
            }
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // බොත්තම් සහ modal element වලට reference ලබා ගැනීම
            const trendingButton = document.getElementById('trendingButton');
            const popularButton = document.getElementById('popularButton');
            const messageModal = document.getElementById('messageModal');
            const closeModalButton = document.getElementById('closeModalButton');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalContent = document.getElementById('modalContent');

            // wallpaper container එකට සහ load more බොත්තමට reference ලබා ගැනීම
            const featuredWallpapersContainer = document.getElementById('featuredWallpapersContainer');
            const loadMoreButton = document.getElementById('loadMoreButton');
            const featuredWallpapersTitle = document.getElementById('featuredWallpapersTitle');

            // Carousel elements
            const categoriesCarousel = document.getElementById('categories-carousel');
            const prevCategoryButton = document.getElementById('prevCategory');
            const nextCategoryButton = document.getElementById('nextCategory');
            const categoryPagination = document.getElementById('category-pagination');
            let categoryCards = []; // Will be populated after DOM is ready

            let carouselInterval;
            const autoSwipeDelay = 5000; // 5 seconds
            let isDragging = false;
            let startX;
            let scrollLeft;
            let currentIndex = 0;

            // Search elements
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            let currentSearchTerm = null; // To store the current search term

            // Test Supabase connection (optional, for debugging)
            async function testSupabase() {
                try {
                    const { data, error } = await supabase.from('wallpapers').select('*').limit(1);
                    if (error) {
                        console.error('Supabase test query failed:', error.message);
                        showModal('Error', 'Failed to connect to Supabase: ' + error.message);
                    } else {
                        console.log('Supabase connection successful:', data);
                    }
                } catch (err) {
                    console.error('Network error during Supabase test:', err);
                    showModal('Error', 'Network error connecting to Supabase.');
                }
            }
            testSupabase(); // Call the test function

            const wallpapersPerPage = 24;
            let currentPageOffset = 0; // වත්මන් පිටුවේ ආරම්භක offset එක
            let currentFilterCategory = null; // පෙරහන් කිරීමට කාණ්ඩය ගබඩා කරයි
            let hasMoreWallpapers = true; // තවත් wallpapers තිබේදැයි නිරීක්ෂණය කිරීමට

            // Supabase වෙතින් wallpapers ලබා ගැනීමේ ශ්‍රිතය
            async function fetchWallpapers(offset, limit, category = null, searchTerm = null) {
                let query = supabase
                    .from('wallpapers')
                    .select('*'); // සියලුම තීරු තෝරන්න

                if (category) {
                    // Use .contains() for JSONB array filtering
                    query = query.contains('labels', [category]);
                }

                if (searchTerm) {
                    // Apply search filter using .or() for title or description
                    query = query.or(`title.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`);
                }

                // created_at අනුව නවතම ඒවා මුලින්ම පෙන්වීමට
                query = query.order('created_at', { ascending: false });

                // Pagination සඳහා limit සහ offset යොදන්න
                query = query.range(offset, offset + limit - 1);

                const { data, error } = await query;

                if (error) {
                    console.error('Error fetching wallpapers:', error.message);
                    showModal('Error', 'Failed to load wallpapers. Please add data to your Supabase "wallpapers" table.');
                    return [];
                }
                return data;
            }


            // වත්මන් පිටුව සඳහා wallpapers render කිරීමේ ශ්‍රිතය
            async function renderWallpapers(append = false) {
                if (!append) {
                    featuredWallpapersContainer.innerHTML = ''; // පවතින wallpapers ඉවත් කරන්න
                    currentPageOffset = 0; // නව පෙරහනක් හෝ ආරම්භක load කිරීමක් නම් offset reset කරන්න
                }

                // පෙරහන් කළ wallpapers ලබා ගැනීම
                const wallpapers = await fetchWallpapers(currentPageOffset, wallpapersPerPage, currentFilterCategory, currentSearchTerm); // await එකතු කරන ලදි

                if (wallpapers.length < wallpapersPerPage) {
                    hasMoreWallpapers = false; // තවත් wallpapers නොමැති බව සලකුණු කරන්න
                    loadMoreButton.style.display = 'none'; // Load More බොත්තම සඟවන්න
                } else {
                    hasMoreWallpapers = true;
                    loadMoreButton.style.display = 'block'; // Load More බොත්තම පෙන්වන්න
                }

                if (wallpapers.length === 0 && !append) {
                    featuredWallpapersContainer.innerHTML = '<p class="text-center text-gray-400 text-lg col-span-full">No wallpapers found for this category or search term. Please add data to your Supabase "wallpapers" table.</p>';
                    return;
                }

                // featured section එකේ මාතෘකාව යාවත්කාලීන කරන්න
                if (currentFilterCategory) {
                    featuredWallpapersTitle.textContent = `Wallpapers in "${currentFilterCategory.charAt(0).toUpperCase() + currentFilterCategory.slice(1)}" Category`;
                } else if (currentSearchTerm) {
                    featuredWallpapersTitle.textContent = `Search Results for "${currentSearchTerm}"`;
                }
                else {
                    featuredWallpapersTitle.textContent = "Featured Wallpapers";
                }
                loadMoreButton.textContent = `Load More ${currentFilterCategory ? currentFilterCategory.charAt(0).toUpperCase() + currentFilterCategory.slice(1) + ' ' : ''}Wallpapers`;


                wallpapers.forEach(wallpaper => {
                    const wallpaperCardHtml = `
                        <div class="bg-black bg-opacity-50 backdrop-blur-sm rounded-3xl p-2 shadow-2xl border border-gray-700 transform hover:scale-105 transition duration-300 group cursor-pointer"
                             data-wallpaper-id="${wallpaper.id}"
                             data-wallpaper-title="${wallpaper.title}"
                             data-wallpaper-description="${wallpaper.description}"
                             data-wallpaper-src="${wallpaper.image_url}"
                             data-wallpaper-labels="${(wallpaper.labels || []).join(',')}" >
                            <img src="${wallpaper.image_url}" alt="${wallpaper.title}" class="w-full h-80 object-cover rounded-lg mb-4 shadow-md group-hover:shadow-xl transition duration-300" onerror="this.onerror=null;this.src='https://placehold.co/300x533/000000/FFFFFF?text=Image+Error';">
                            <!-- Download button removed as per user request -->
                        </div>
                    `;
                    featuredWallpapersContainer.insertAdjacentHTML('beforeend', wallpaperCardHtml);
                });

                // අලුතින් render කළ wallpaper card වලට event listeners එකතු කිරීම
                document.querySelectorAll('#featuredWallpapersContainer > div').forEach(card => {
                    card.addEventListener('click', (event) => {
                        // බොත්තම ක්ලික් කිරීමෙන් card click එකක් ඇතිවීම වළක්වන්න
                        if (event.target.tagName === 'BUTTON') {
                            return;
                        }

                        const wallpaperId = card.dataset.wallpaperId;
                        // detail.html වෙත යැවීමට ids parameter එක භාවිතා කරන්න
                        // Changed to use a simple relative path
                        const detailPageUrl = `detail.html?ids=${wallpaperId}`;
                        window.location.href = detailPageUrl; // Load in current tab
                    });
                });

                // නව අන්තර්ගතය load කිරීමෙන් පසු featured section එකේ ඉහළට scroll කරන්න
                // Removed auto-scrolling as per user request
                // if (!append) { // නව පෙරහනක් හෝ ආරම්භක load කිරීමක් නම් පමණක් scroll කරන්න
                //     window.scrollTo({ top: featuredWallpapersContainer.offsetTop - 100, behavior: 'smooth' });
                // }
            }

            // URL parameters parse කිරීමේ ශ්‍රිතය
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                var results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            };


            // category බොත්තම් සඳහා event listeners (These are for the old category buttons, will be replaced by category cards)
            document.querySelectorAll('.category-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const category = event.target.dataset.category;
                    currentFilterCategory = category;
                    currentSearchTerm = null; // Clear search term when category is selected
                    currentPageOffset = 0; // නව පෙරහන සඳහා pagination reset කරන්න
                    renderWallpapers(); // නව පෙරහන සමඟ wallpapers render කරන්න
                });
            });

            // Initial render call moved here, after all elements are defined and data is ready
            const urlCategory = getUrlParameter('category');
            if (urlCategory) {
                currentFilterCategory = urlCategory;
            }
            // renderWallpapers() will be called after categories are loaded

            // "Load More Wallpapers" බොත්තම සඳහා event listener
            loadMoreButton.addEventListener('click', () => {
                if (hasMoreWallpapers) {
                    currentPageOffset += wallpapersPerPage;
                    renderWallpapers(true); // පවතින ඒවාට අලුතින් එකතු කරන්න
                }
            });

            // --- Supabase Click Tracking ---
            async function trackWallpaperClick(wallpaperId) {
                try {
                    // Supabase හි 'wallpapers' table එකෙන් වත්මන් clicks ගණන ලබා ගන්න
                    const { data: currentData, error: fetchError } = await supabase
                        .from('wallpapers')
                        .select('clicks')
                        .eq('id', wallpaperId) // Supabase ID එක කෙලින්ම භාවිතා කරන්න
                        .single();

                    if (fetchError && fetchError.code !== 'PGRST116') { // PGRST116 යනු "No rows found"
                        console.error(`Error fetching current clicks for ${wallpaperId}:`, fetchError.message);
                        return;
                    }

                    const currentClicks = currentData ? currentData.clicks : 0;
                    const newClicks = currentClicks + 1;

                    // දත්ත ගබඩාවේ 'wallpapers' table එකේ අනුරූප වෝල්පේපරයේ click count එක වැඩි කරන්න
                    const { data, error } = await supabase
                        .from('wallpapers')
                        .update({ clicks: newClicks })
                        .eq('id', wallpaperId); // Supabase ID එක කෙලින්ම භාවිතා කරන්න

                    if (error) {
                        console.error(`Error tracking click for Supabase ID ${wallpaperId}:`, error.message);
                    } else {
                        console.log(`Click tracked for wallpaper ${wallpaperId}: New clicks = ${newClicks}`);
                    }
                } catch (error) {
                    console.error("Network error tracking click:", error);
                }
            }

            // --- Trending/Popular දත්ත සඳහා Supabase ---
            // Now fetches image_url, description, and labels as well
            async function getAggregatedClicks(limit, timeframeInDays = null) {
                let query = supabase
                    .from('wallpapers')
                    .select('id, title, clicks, image_url, description, labels') // Added image_url, description, labels
                    .order('clicks', { ascending: false }) // clicks අනුව descending order කරන්න
                    .limit(limit); // Set the limit for the number of wallpapers

                if (timeframeInDays) {
                    const date = new Date();
                    date.setDate(date.getDate() - timeframeInDays);
                    query = query.gte('created_at', date.toISOString()); // Filter by created_at for timeframe
                }

                const { data, error } = await query;

                if (error) {
                    console.error(`Error fetching aggregated clicks with timeframe ${timeframeInDays} days:`, error.message);
                    // Provide a user-friendly message if data fetching fails
                    showModal('Error', 'Failed to load trending/popular wallpapers. Please ensure your Supabase "wallpapers" table has data.');
                    return [];
                }

                return data.map(item => ({
                    wallpaperId: item.id,
                    title: item.title,
                    clicks: item.clicks,
                    image_url: item.image_url,
                    description: item.description,
                    labels: item.labels // labels array එකක් ලෙසම ලබා ගනී
                }));
            }

            // --- Modal Functions ---
            function showModal(title, message, content = '') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalContent.innerHTML = content;
                messageModal.classList.remove('hidden');
                messageModal.classList.add('flex');
            }

            function hideModal() {
                modalTitle.textContent = '';
                modalMessage.textContent = '';
                modalContent.innerHTML = '';
                messageModal.classList.add('hidden');
                messageModal.classList.remove('flex');
            }

            closeModalButton.addEventListener('click', hideModal);
            messageModal.addEventListener('click', (event) => {
                if (event.target === messageModal) {
                    hideModal();
                }
            });

            // --- Trending සහ Popular බොත්තම් Logic ---
            trendingButton.addEventListener('click', async () => {
                showModal('Fetching Trending Wallpapers', 'Please wait while we analyze the latest trends...');
                try {
                    const trendingData = await getAggregatedClicks(30, 7); // Get up to 30 wallpapers from last 7 days
                    let contentHtml = ''; // Initialize empty to build content

                    if (trendingData.length > 0) {
                        contentHtml += '<p class="text-xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">Top Trending Wallpapers (Last 7 Days):</p>';
                        // Use the same grid structure as featured wallpapers
                        contentHtml += '<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">';
                        trendingData.forEach(item => {
                            // Create a clickable card for each wallpaper, matching featured wallpaper card structure
                            const wallpaperLabels = (item.labels || []).join(',');
                            // Pass 'ids' parameter to detail.html
                            // Changed to use a simple relative path
                            const detailPageUrl = `detail.html?ids=${item.wallpaperId}`;

                            contentHtml += `
                                <div class="bg-black bg-opacity-50 backdrop-blur-sm rounded-3xl p-2 shadow-2xl border border-gray-700 transform hover:scale-105 transition duration-300 group cursor-pointer"
                                     data-wallpaper-id="${item.wallpaperId}"
                                     data-wallpaper-title="${item.title}"
                                     data-wallpaper-description="${item.description || ''}"
                                     data-wallpaper-src="${item.image_url}"
                                     data-wallpaper-labels="${wallpaperLabels}">
                                    <img src="${item.image_url}" alt="${item.title}" class="w-full h-72 object-cover rounded-lg mb-3 shadow-md group-hover:shadow-xl transition duration-300" onerror="this.onerror=null;this.src='https://placehold.co/300x533/000000/FFFFFF?text=Image+Error';">
                                    </div>
                            `;
                        });
                        contentHtml += '</div>'; // Close grid
                    } else {
                        contentHtml += '<p class="text-gray-400">No trending wallpapers found for the last 7 days. Please add some data to your Supabase "wallpapers" table with various click counts and recent creation dates.</p>';
                    }

                    modalTitle.textContent = 'Trending Wallpapers Analysis';
                    modalMessage.textContent = 'Here are the current trending wallpapers based on recent activity:';
                    modalContent.innerHTML = contentHtml;

                    // Add click listeners to the newly rendered modal content images
                    document.querySelectorAll('#modalContent > div > div').forEach(card => {
                        card.addEventListener('click', (event) => {
                            const wallpaperId = card.dataset.wallpaperId;
                            trackWallpaperClick(wallpaperId); // Track click
                            // Pass 'ids' parameter to detail.html
                            // Changed to use a simple relative path
                            const detailPageUrl = `detail.html?ids=${wallpaperId}`;
                            window.location.href = detailPageUrl; // Load in current tab
                        });
                    });

                } catch (error) {
                    modalTitle.textContent = 'Error';
                    modalMessage.textContent = 'Failed to fetch popular data. Please try again later.';
                    modalContent.innerHTML = `<p class="text-red-400">Error details: ${error.message}</p>`;
                    console.error('Error fetching popular data:', error);
                }
            });

            popularButton.addEventListener('click', async () => {
                showModal('Fetching Popular Wallpapers', 'Please wait while we gather popular choices...');
                try {
                    const popularData = await getAggregatedClicks(30, 30); // Get up to 30 wallpapers from last 30 days
                    let contentHtml = ''; // Initialize empty to build content

                    if (popularData.length > 0) {
                        contentHtml += '<p class="text-xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">Most Popular Wallpapers (Last 30 Days):</p>';
                        // Use the same grid structure as featured wallpapers
                        contentHtml += '<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">';
                        popularData.forEach(item => {
                            // Create a clickable card for each wallpaper, matching featured wallpaper card structure
                            const wallpaperLabels = (item.labels || []).join(',');
                            // Pass 'ids' parameter to detail.html
                            // Changed to use a simple relative path
                            const detailPageUrl = `detail.html?ids=${item.wallpaperId}`;

                            contentHtml += `
                                <div class="bg-black bg-opacity-50 backdrop-blur-sm rounded-3xl p-2 shadow-2xl border border-gray-700 transform hover:scale-105 transition duration-300 group cursor-pointer"
                                     data-wallpaper-id="${item.wallpaperId}"
                                     data-wallpaper-title="${item.title}"
                                     data-wallpaper-description="${item.description || ''}"
                                     data-wallpaper-src="${item.image_url}"
                                     data-wallpaper-labels="${wallpaperLabels}">
                                    <img src="${item.image_url}" alt="${item.title}" class="w-full h-72 object-cover rounded-lg mb-3 shadow-md group-hover:shadow-xl transition duration-300" onerror="this.onerror=null;this.src='https://placehold.co/300x533/000000/FFFFFF?text=Image+Error';">
                                    </div>
                            `;
                        });
                        contentHtml += '</div>'; // Close grid
                    } else {
                        contentHtml += '<p class="text-gray-400">No popular wallpapers found for the last 30 days. Please add some data to your Supabase "wallpapers" table with various click counts and recent creation dates.</p>';
                    }

                    modalTitle.textContent = 'Popular Wallpapers Analysis';
                    modalMessage.textContent = 'Here are the most popular wallpapers based on overall engagement:';
                    modalContent.innerHTML = contentHtml;

                    // Add click listeners to the newly rendered modal content images
                    document.querySelectorAll('#modalContent > div > div').forEach(card => {
                        card.addEventListener('click', (event) => {
                            const wallpaperId = card.dataset.wallpaperId;
                            trackWallpaperClick(wallpaperId); // Track click
                            // Pass 'ids' parameter to detail.html
                            // Changed to use a simple relative path
                            const detailPageUrl = `detail.html?ids=${wallpaperId}`;
                            window.location.href = detailPageUrl; // Load in current tab
                        });
                    });

                } catch (error) {
                    modalTitle.textContent = 'Error';
                    modalMessage.textContent = 'Failed to fetch popular data. Please try again later.';
                    modalContent.innerHTML = `<p class="text-red-400">Error details: ${error.message}</p>`;
                    console.error('Error fetching popular data:', error);
                }
            });

            // --- Supabase වෙතින් කාණ්ඩ ලබා ගැනීමේ ශ්‍රිතය ---
            async function fetchCategoriesFromSupabase() {
                try {
                    const desiredCategories = ['Green', 'Anime']; // Explicitly define desired categories
                    const categoriesData = [];

                    for (const categoryName of desiredCategories) {
                        // Fetch one wallpaper for each category to get a representative image
                        const { data: wallpapers, error } = await supabase
                            .from('wallpapers')
                            .select('image_url')
                            .contains('labels', [categoryName])
                            .limit(1); // Only need one image

                        if (error) {
                            console.error(`Error fetching image for category ${categoryName}:`, error.message);
                            // Continue to next category even if one fails
                            categoriesData.push({
                                name: categoryName,
                                imageUrl: `https://placehold.co/400x225/000000/FFFFFF?text=${categoryName}` // Fallback
                            });
                            continue;
                        }

                        let imageUrl = `https://placehold.co/400x225/000000/FFFFFF?text=${categoryName}`; // Default fallback
                        if (wallpapers && wallpapers.length > 0) {
                            imageUrl = wallpapers[0].image_url;
                        }

                        categoriesData.push({
                            name: categoryName,
                            imageUrl: imageUrl
                        });
                    }

                    // Sort categories if desired (e.g., alphabetically)
                    categoriesData.sort((a, b) => a.name.localeCompare(b.name));

                    return categoriesData;

                } catch (err) {
                    console.error('Network error fetching categories:', err);
                    showModal('Error', 'Failed to load categories. Please ensure your Supabase "wallpapers" table has data with "Green" and "Anime" labels.');
                    return [];
                }
            }

            // --- කාණ්ඩ ගතිකව load කර carousel initialize කිරීමේ ශ්‍රිතය ---
            async function loadCategoriesAndInitializeCarousel() {
                const categories = await fetchCategoriesFromSupabase();
                categoriesCarousel.innerHTML = ''; // Clear existing content

                if (categories.length === 0) {
                    categoriesCarousel.innerHTML = '<p class="text-center text-gray-400 text-lg col-span-full">No categories found or filtered for Green/Anime. Please add data to your Supabase "wallpapers" table with these labels.</p>';
                    return;
                }

                categories.forEach(category => {
                    const categoryCardHtml = `
                        <div class="flex-shrink-0 w-full sm:w-1/2 lg:w-1/3 bg-black bg-opacity-50 backdrop-blur-sm rounded-3xl p-1 shadow-2xl border border-gray-700 transform hover:scale-105 transition duration-300 cursor-pointer category-card"
                             data-category-name="${category.name}">
                            <h2 class="text-sm font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400">${category.name}</h2>
                            <div class="flex justify-center items-center">
                                <img src="${category.imageUrl}" alt="${category.name} Wallpaper" class="w-full h-40 object-cover rounded-lg shadow-md hover:shadow-xl transition duration-300" onerror="this.onerror=null;this.src='https://placehold.co/400x225/000000/FFFFFF?text=${category.name}';">
                            </div>
                        </div>
                    `;
                    categoriesCarousel.insertAdjacentHTML('beforeend', categoryCardHtml);
                });

                // Add click listeners to the dynamically created category cards
                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', (event) => {
                        const category = card.dataset.categoryName;
                        currentFilterCategory = category;
                        currentSearchTerm = null; // Clear search term when category is selected
                        currentPageOffset = 0; // Reset pagination for new filter
                        // Use window.location.href for full reload to bypass pushState security error
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set('category', category);
                        window.location.href = newUrl.href;
                    });
                });

                initializeCarousel(); // Re-initialize carousel after adding new cards
            }

            // --- Carousel Logic for Categories ---
            function initializeCarousel() {
                categoryCards = Array.from(categoriesCarousel.children); // Get all direct children as cards
                if (categoryCards.length > 0) {
                    updatePaginationDots();
                    startAutoSwipe();
                }
            }

            function updatePaginationDots() {
                categoryPagination.innerHTML = '';
                categoryCards.forEach((_, index) => {
                    const dot = document.createElement('span');
                    dot.classList.add('w-3', 'h-3', 'bg-gray-600', 'rounded-full', 'cursor-pointer', 'transition-colors', 'duration-300', 'mx-1'); // Added mx-1 for spacing
                    if (index === currentIndex) {
                        dot.classList.remove('bg-gray-600');
                        dot.classList.add('bg-purple-500');
                    }
                    dot.addEventListener('click', () => {
                        currentIndex = index;
                        scrollToCurrentIndex();
                        resetAutoSwipe();
                    });
                    categoryPagination.appendChild(dot);
                });
            }

            function scrollToCurrentIndex() {
                if (categoryCards.length > 0) {
                    // Calculate the scroll position based on the first card's width and gap
                    const firstCard = categoryCards[0];
                    const cardWidth = firstCard.offsetWidth;
                    // Get the computed gap from the parent flex container
                    const style = window.getComputedStyle(categoriesCarousel);
                    const gap = parseFloat(style.getPropertyValue('gap')) || 0;

                    const scrollPosition = currentIndex * (cardWidth + gap);

                    categoriesCarousel.scrollTo({
                        left: scrollPosition,
                        behavior: 'smooth'
                    });
                }
            }

            function nextSlide() {
                currentIndex = (currentIndex + 1) % categoryCards.length;
                scrollToCurrentIndex();
                updatePaginationDots(); // Update dots after auto-swipe
            }

            function prevSlide() {
                currentIndex = (currentIndex - 1 + categoryCards.length) % categoryCards.length;
                scrollToCurrentIndex();
                updatePaginationDots(); // Update dots after auto-swipe
            }

            function startAutoSwipe() {
                carouselInterval = setInterval(nextSlide, autoSwipeDelay);
            }

            function resetAutoSwipe() {
                clearInterval(carouselInterval);
                startAutoSwipe();
            }

            // Event Listeners for manual navigation (arrows)
            prevCategoryButton.addEventListener('click', () => {
                prevSlide();
                resetAutoSwipe();
            });

            nextCategoryButton.addEventListener('click', () => {
                nextSlide();
                resetAutoSwipe();
            });

            // Drag/Touch functionality
            categoriesCarousel.addEventListener('mousedown', (e) => {
                isDragging = true;
                categoriesCarousel.classList.add('cursor-grabbing');
                startX = e.pageX - categoriesCarousel.offsetLeft;
                scrollLeft = categoriesCarousel.scrollLeft;
                clearInterval(carouselInterval); // Pause auto-swipe on manual interaction
            });

            categoriesCarousel.addEventListener('mouseleave', () => {
                isDragging = false;
                categoriesCarousel.classList.remove('cursor-grabbing');
            });

            categoriesCarousel.addEventListener('mouseup', () => {
                isDragging = false;
                categoriesCarousel.classList.remove('cursor-grabbing');
                // No snapping logic here, let natural scroll inertia take over
                resetAutoSwipe(); // Resume auto-swipe after a short delay
            });

            categoriesCarousel.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - categoriesCarousel.offsetLeft;
                const walk = (x - startX) * 1.5; // Multiplier for faster scroll
                categoriesCarousel.scrollLeft = scrollLeft - walk;
            });

            // Touch events for mobile
            categoriesCarousel.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].pageX - categoriesCarousel.offsetLeft;
                scrollLeft = categoriesCarousel.scrollLeft;
                clearInterval(carouselInterval);
            });

            categoriesCarousel.addEventListener('touchend', () => {
                isDragging = false;
                // No snapping logic here, let natural scroll inertia take over
                resetAutoSwipe();
            });

            categoriesCarousel.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.touches[0].pageX - categoriesCarousel.offsetLeft;
                const walk = (x - startX) * 1.5;
                categoriesCarousel.scrollLeft = scrollLeft - walk;
            });

            // Listen for scroll end to update pagination dots accurately after manual scroll
            let scrollTimeout;
            categoriesCarousel.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    if (!isDragging) { // Only update if not actively dragging
                        const firstCard = categoryCards[0];
                        if (firstCard) {
                            const cardWidth = firstCard.offsetWidth;
                            const style = window.getComputedStyle(categoriesCarousel);
                            const gap = parseFloat(style.getPropertyValue('gap')) || 0;
                            currentIndex = Math.round(categoriesCarousel.scrollLeft / (cardWidth + gap));
                            updatePaginationDots();
                        }
                    }
                }, 150); // Debounce time
            });

            // Search functionality event listeners
            searchButton.addEventListener('click', () => {
                const searchTerm = searchInput.value.trim();
                currentSearchTerm = searchTerm;
                currentFilterCategory = null; // Clear category filter when searching
                currentPageOffset = 0; // Reset pagination for new search
                renderWallpapers(); // Render wallpapers with search term
            });

            searchInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    const searchTerm = searchInput.value.trim();
                    currentSearchTerm = searchTerm;
                    currentFilterCategory = null; // Clear category filter when searching
                    currentPageOffset = 0; // Reset pagination for new search
                    renderWallpapers(); // Render wallpapers with search term
                }
            });

            // Initial setup for categories and wallpapers
            loadCategoriesAndInitializeCarousel().then(() => {
                renderWallpapers(); // Call initial render after categories are loaded
            });
        }; // End of window.onload
    </script>
</body>
</html>
